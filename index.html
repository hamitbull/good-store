<!DOCTYPE html>
<html lang="ha">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mhyasi Store â€” Good Mhyasi</title>
  <meta name="theme-color" content="#6A0DAD"/>
  <link rel="manifest" href="manifest.json"/>
  <style>
    :root{
      --accent1:#6a11cb;
      --accent2:#2575fc;
      --panel:#fff;
      --fg:#0f172a;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    header{
      padding:12px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    main{
      padding:18px;
      max-width:1100px;
      margin:18px auto;
      display:grid;
      grid-template-columns:1fr 420px;
      gap:16px;
    }
    .panel{
      background:var(--panel);
      color:var(--fg);
      border-radius:12px;
      padding:14px;
      box-shadow: 0 6px 20px rgba(11,15,30,0.06);
    }
    input,button,select,textarea{
      padding:8px;
      border-radius:8px;
      border:1px solid #e6e9ef;
      font-size:14px;
    }
    .btn{
      background:linear-gradient(90deg,var(--accent2),var(--accent1));
      color:white;
      border:none;
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    .btn-alt{background:#fff;color:#111;border:1px solid #e6e9ef}
    .small{font-size:13px;color:#64748b}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid #eef2f7;text-align:left}
    @media(max-width:980px){main{grid-template-columns:1fr;padding:12px}}
    #summaryPanel div{margin:6px 0;font-weight:700}
    .muted{color:#64748b;font-size:13px}
    .searchWrap{display:flex;gap:8px;align-items:center}
    .installBtn{background:#fff;color:#111;border-radius:8px;padding:6px 8px;border:1px solid #e6e9ef;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:12px">
      <div style="font-weight:800;font-size:18px">ðŸŒŠ Mhyasi Store</div>
      <div class="small" style="opacity:.9">Good Mhyasi</div>
    </div>
    <div id="authControls"></div>
  </header>

  <main>
    <div>
      <!-- SUMMARY TOP -->
      <div class="panel" id="summaryPanel" style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>ðŸ’° Total Sold: <span id="totalSoldText">â‚¦0</span></div>
        <div>ðŸ“¦ Stock Value: <span id="stockValueText">â‚¦0</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnInstall" class="installBtn" style="display:none">Install App</button>
          <button id="refreshBtn" class="installBtn">Refresh</button>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="panel" id="profilePanel">
        <div style="display:flex;align-items:center;gap:12px">
          <img id="shopLogo" src="" alt="logo" style="width:72px;height:72px;border-radius:12px;object-fit:cover;display:none"/>
          <div style="flex:1">
            <div style="font-weight:700" id="shopName">Not logged</div>
            <div class="small" id="shopAddress">â€”</div>
          </div>
          <div><button class="btn" id="btnProfile">Profile</button></div>
        </div>
      </div>

      <!-- PRODUCTS + SEARCH -->
      <div class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div style="font-weight:700">Products</div>
          <div class="small">Free: <b id="freeLimitText">5</b></div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <input id="pName" placeholder="Name" style="flex:1;min-width:160px" />
          <input id="pPrice" placeholder="Price" type="number" style="width:110px" />
          <input id="pQty" placeholder="Qty" type="number" style="width:80px" />
          <button id="saveProductBtn" class="btn">Save</button>
        </div>

        <div style="margin-top:10px;display:flex;align-items:center;gap:8px" class="searchWrap">
          <input id="searchInput" placeholder="Search product..." style="flex:1" />
          <select id="sortSelect" style="width:140px">
            <option value="">Sort: default</option>
            <option value="name_asc">Name â†‘</option>
            <option value="name_desc">Name â†“</option>
            <option value="price_asc">Price â†‘</option>
            <option value="price_desc">Price â†“</option>
            <option value="qty_asc">Qty â†‘</option>
            <option value="qty_desc">Qty â†“</option>
          </select>
        </div>

        <div style="margin-top:8px;max-height:300px;overflow:auto">
          <table id="productsTable"><thead><tr><th>Name</th><th>Price</th><th>Qty</th><th style="width:220px">Action</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <!-- INVOICE HISTORY -->
      <div class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Invoice History</div>
          <div class="small">Click View to print</div>
        </div>
        <div id="historyList" style="margin-top:8px;max-height:220px;overflow:auto"></div>
      </div>
    </div>

    <div>
      <!-- CART -->
      <div class="panel">
        <div style="font-weight:700">Cart</div>
        <div style="margin-top:8px">
          <div id="cartItems"></div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="customerName" placeholder="Customer (optional)" style="flex:1" />
            <div style="min-width:140px;text-align:right">
              <div class="small">Total</div>
              <div id="cartTotal" style="font-weight:800">â‚¦0</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="completeSaleBtn" class="btn">Complete Sale</button>
            <button id="printBtn" class="btn">Print</button>
            <button id="clearCartBtn" class="btn btn-alt">Clear</button>
          </div>
        </div>
      </div>

      <!-- UNLOCK / ADMIN -->
      <div class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Unlock & Admin</div>
          <div class="small">Requests â€¢ Codes</div>
        </div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <button id="btnRequest" class="btn">Request Unlock</button>
          <button id="btnEnterCode" class="btn btn-alt">Enter Code</button>
          <div style="display:flex;gap:8px">
            <button id="btnAdmin" class="btn btn-alt">Admin</button>
            <button id="btnMsgAdmin" class="btn">Message Admin</button>
          </div>
          <div class="muted" style="margin-top:6px">Admin WA: <b id="adminPhoneText">+2349013025066</b></div>
        </div>
      </div>
    </div>
  </main>

  <div id="modalRoot" style="display:none"></div>

<script>
/* ---------- CONFIG ---------- */
const API_BASE = "https://good-mhyasi.onrender.com"; // backend URL
const ADMIN_PHONE = "+2349013025066";
let deferredPrompt = null;

/* ---------- STATE ---------- */
let token = localStorage.getItem('mhyasi_token') || null;
let currentUser = JSON.parse(localStorage.getItem('mhyasi_user') || 'null') || null;
let products = [];
let cart = [];
let invoices = [];

/* ---------- HELPERS ---------- */
function $(s){ return document.querySelector(s); }
function toCurrency(n){ return "â‚¦" + Number(n||0).toLocaleString(); }
function showModal(html){ const r=document.getElementById('modalRoot'); r.style.display='block'; r.innerHTML = '<div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999"><div style="background:#fff;color:#000;padding:16px;border-radius:12px;max-width:96%;width:720px;max-height:90vh;overflow:auto">'+html+'<div style="text-align:right;margin-top:12px"><button onclick="closeModal()" style="padding:8px">Close</button></div></div></div>'; }
function closeModal(){ const r=document.getElementById('modalRoot'); r.style.display='none'; r.innerHTML=''; }
function setAuth(tokenVal, userVal){
  token = tokenVal;
  currentUser = userVal;
  if(token) localStorage.setItem('mhyasi_token', token); else localStorage.removeItem('mhyasi_token');
  if(userVal) localStorage.setItem('mhyasi_user', JSON.stringify(userVal)); else localStorage.removeItem('mhyasi_user');
}
function apiFetch(path, opts = {}) {
  opts.headers = opts.headers || {};
  if (token) opts.headers['Authorization'] = 'Bearer ' + token;
  return fetch(API_BASE + path, opts).then(r => r.json().catch(()=>({ok:false,error:'invalid json'})));
}

/* ---------- AUTH UI ---------- */
function renderAuth(){
  const ctrl = $('#authControls');
  if(token && currentUser){
    ctrl.innerHTML = `<span style="margin-right:12px;font-weight:700">${currentUser.username}${currentUser.role==='admin'?' (admin)':''}</span><button id="btnLogout" class="btn btn-alt">Logout</button>`;
    $('#btnLogout').onclick = async ()=>{ setAuth(null,null); products=[]; cart=[]; invoices=[]; renderAuth(); renderProfile(); renderProductsTable(); renderCart(); renderInvoices(); updateSummary(); };
  } else {
    ctrl.innerHTML = `<button id="btnLogin" class="btn btn-alt">Login</button> <button id="btnRegister" class="btn btn-alt">Register</button>`;
    $('#btnLogin').onclick = openLogin;
    $('#btnRegister').onclick = openRegister;
  }
}

/* ---------- PROFILE ---------- */
function renderProfile(){
  if(!currentUser){ $('#shopLogo').style.display='none'; $('#shopName').textContent='Not logged'; $('#shopAddress').textContent='â€”'; return; }
  $('#shopName').textContent = currentUser.shop_name || currentUser.username;
  $('#shopAddress').textContent = currentUser.shop_address || '';
  if(currentUser.logo_path){
    $('#shopLogo').src = API_BASE.replace(/\/$/,'') + currentUser.logo_path;
    $('#shopLogo').style.display = 'block';
  } else $('#shopLogo').style.display='none';
}

/* ---------- LOGIN / REGISTER ---------- */
function openRegister(){
  showModal(`<h3>Register</h3><div style="display:flex;gap:8px"><input id="regUser" placeholder="username" style="flex:1"/><input id="regPass" placeholder="password" type="password" style="width:200px"/></div><div style="margin-top:8px"><input id="regShop" placeholder="Shop name (optional)" style="width:100%"/><input id="regAddr" placeholder="Shop address (optional)" style="width:100%;margin-top:6px"/></div><div style="text-align:right;margin-top:8px"><button id="doReg" class="btn">Create</button></div>`);
  setTimeout(()=>{ $('#doReg').onclick = async ()=>{
    const u = $('#regUser').value.trim(), p = $('#regPass').value, s = $('#regShop').value, a = $('#regAddr').value;
    if(!u || !p) return alert('user & pass required');
    const res = await apiFetch('/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p, shop_name: s, shop_address: a })});
    if(!res.ok) return alert(res.error || 'Register failed');
    alert('Registered â€” please login');
    closeModal();
  }; },50);
}
function openLogin(){
  showModal(`<h3>Login</h3><div style="display:flex;gap:8px"><input id="loginUser" placeholder="username" style="flex:1"/><input id="loginPass" placeholder="password" type="password" style="width:200px"/></div><div style="text-align:right;margin-top:8px"><button id="doLogin" class="btn">Login</button></div>`);
  setTimeout(()=>{ $('#doLogin').onclick = async ()=>{
    const u = $('#loginUser').value.trim(), p = $('#loginPass').value;
    if(!u||!p) return alert('user & pass required');
    const res = await apiFetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p })});
    if(!res.ok) return alert(res.error || 'Login failed');
    setAuth(res.token, res.user);
    closeModal();
    renderAuth(); renderProfile(); await loadProducts(); await loadInvoices(); updateSummary();
  }; },50);
}

/* ---------- PROFILE EDIT (upload logo) ---------- */
$('#btnProfile').onclick = ()=> {
  if(!currentUser) return openLogin();
  showModal(`<h3>Profile</h3><div><input id="shopNameInput" placeholder="Shop name" style="width:100%;margin-bottom:8px"/><input id="shopAddrInput" placeholder="Shop address" style="width:100%;margin-bottom:8px"/><div style="margin-top:8px"><label>Upload logo:</label><input type="file" id="logoFile"></div></div><div style="text-align:right;margin-top:8px"><button id="saveProfile" class="btn">Save</button></div>`);
  setTimeout(()=> {
    $('#shopNameInput').value = currentUser.shop_name || '';
    $('#shopAddrInput').value = currentUser.shop_address || '';
    $('#saveProfile').onclick = async ()=>{
      const sn = $('#shopNameInput').value.trim(), sa = $('#shopAddrInput').value.trim();
      await apiFetch('/api/profile', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ shop_name: sn, shop_address: sa })});
      const f = $('#logoFile').files[0];
      if(f){
        const fd = new FormData(); fd.append('logo', f);
        const r = await fetch(API_BASE + '/api/profile/logo', { method:'POST', headers:{'Authorization':'Bearer '+token}, body: fd });
        const jr = await r.json();
        if(jr.ok) currentUser.logo_path = jr.logo_path;
      }
      // refresh me
      const me = await apiFetch('/api/me');
      if(me.ok) currentUser = me.user;
      setAuth(token, currentUser);
      closeModal(); renderProfile(); updateSummary();
    };
  },50);
};

/* ---------- PRODUCTS CRUD + SEARCH + SORT ---------- */
$('#saveProductBtn').onclick = async ()=>{
  if(!currentUser) return openLogin();
  const name = $('#pName').value.trim(); const price = Number($('#pPrice').value)||0; const qty = Number($('#pQty').value)||0;
  if(!name) return alert('Enter name');
  const res = await apiFetch('/api/products', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, price, qty })});
  if(!res.ok) return alert(res.error||'Error');
  $('#pName').value=''; $('#pPrice').value=''; $('#pQty').value='';
  await loadProducts(); updateSummary();
};

async function loadProducts(){
  if(!currentUser) { products = []; renderProductsTable(); updateSummary(); return; }
  const r = await apiFetch('/api/products');
  products = r.ok ? r.products || [] : [];
  renderProductsTable();
  updateSummary();
}

function renderProductsTable(filtered){
  const tbody = $('#productsTable tbody'); tbody.innerHTML='';
  const list = Array.isArray(filtered) ? filtered : products;
  list.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.name}</td><td>${toCurrency(p.price)}</td><td>${p.qty}</td>
      <td>
        <button class="btn" onclick='addToCart("${p.id}")'>Add</button>
        <button class="btn btn-alt" onclick='openEdit("${p.id}")'>Edit</button>
        <button class="btn btn-alt" onclick='delProduct("${p.id}")'>Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* search + sort */
$('#searchInput').addEventListener('input', ()=> {
  applyFilterSort();
});
$('#sortSelect').addEventListener('change', ()=> {
  applyFilterSort();
});

function applyFilterSort(){
  const q = $('#searchInput').value.trim().toLowerCase();
  const sort = $('#sortSelect').value;
  let out = products.slice();
  if(q){
    out = out.filter(p => (p.name||'').toLowerCase().includes(q));
  }
  if(sort){
    const [field, dir] = sort.split('_');
    out.sort((a,b)=>{
      let A = a[field], B = b[field];
      if(field === 'name'){ A = (A||'').toLowerCase(); B = (B||'').toLowerCase(); }
      A = (A===undefined||A===null)?'':A; B = (B===undefined||B===null)?'':B;
      if(A < B) return dir === 'asc' ? -1 : 1;
      if(A > B) return dir === 'asc' ? 1 : -1;
      return 0;
    });
  }
  renderProductsTable(out);
}

/* edit/delete helpers */
window.openEdit = function(id){
  const p = products.find(x=>String(x.id)===String(id)); if(!p) return alert('Product not found');
  showModal(`<h3>Edit product</h3><div style="display:flex;gap:8px"><input id="eName" placeholder="name" value="${p.name}" style="flex:1"/><input id="ePrice" type="number" value="${p.price}" style="width:110px"/><input id="eQty" type="number" value="${p.qty}" style="width:80px"/></div><div style="text-align:right;margin-top:8px"><button id="doEdit" class="btn">Save</button></div>`);
  setTimeout(()=>{ $('#doEdit').onclick = async ()=>{
    const name = $('#eName').value.trim(), price = Number($('#ePrice').value)||0, qty = Number($('#eQty').value)||0;
    const res = await apiFetch('/api/products/' + id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, price, qty })});
    if(!res.ok) return alert(res.error||'Update failed');
    closeModal();
    await loadProducts(); updateSummary();
  }; },50);
};

window.delProduct = async function(id){
  if(!confirm('Delete product?')) return;
  const res = await apiFetch('/api/products/' + id, { method:'DELETE' });
  if(!res.ok) return alert(res.error||'Failed');
  await loadProducts(); updateSummary();
};

/* ---------- CART ---------- */
window.addToCart = function(id){
  const p = products.find(x=>String(x.id)===String(id));
  if(!p) return alert('not found');
  if(p.qty <= 0) return alert('Out of stock');
  const exists = cart.find(c=>c.id == p.id);
  if(exists) {
    // ensure not exceed stock
    if((exists.qty + 1) > p.qty) return alert('Cannot add more than available stock');
    exists.qty += 1;
  } else cart.push({ id: p.id, name: p.name, price: p.price, qty: 1 });
  renderCart();
}
function renderCart(){
  const wrap = $('#cartItems'); wrap.innerHTML='';
  let total=0;
  cart.forEach((c,i)=>{
    total += c.price * c.qty;
    const div = document.createElement('div');
    div.style='display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid #eee';
    div.innerHTML = `<div style="max-width:65%">${c.name} x <input style="width:56px;border-radius:6px;padding:6px;border:1px solid #ddd" type="number" min="1" value="${c.qty}" onchange="changeCartQty(${i},this.value)"></div><div>${toCurrency(c.price*c.qty)} <button onclick='removeCart(${i})' style="margin-left:8px">Remove</button></div>`;
    wrap.appendChild(div);
  });
  $('#cartTotal').textContent = toCurrency(total);
}
function changeCartQty(i, val){
  const n = Math.max(1, Number(val)||1);
  const c = cart[i];
  const prod = products.find(p => String(p.id) === String(c.id));
  if(prod && n > prod.qty) return alert('Kusan fiye da available stock');
  c.qty = n;
  renderCart();
}
function removeCart(i){ cart.splice(i,1); renderCart(); }
$('#clearCartBtn').onclick = ()=>{ if(confirm('Clear cart?')){ cart=[]; renderCart(); } }

/* ---------- INVOICES ---------- */
async function loadInvoices(){
  if(!currentUser) { invoices = []; renderInvoices(); updateSummary(); return; }
  const r = await apiFetch('/api/invoices');
  invoices = r.ok ? r.invoices || [] : [];
  renderInvoices(); updateSummary();
}
function renderInvoices(){
  const wr = $('#historyList'); wr.innerHTML='';
  invoices.forEach(inv=>{
    const date = new Date((inv.created_at||Date.now())*1000).toLocaleString();
    const div = document.createElement('div'); div.style='padding:8px;border-bottom:1px solid #eee';
    div.innerHTML = `<div><b>${inv.invoice_id}</b> â€” ${date}</div><div>${toCurrency(inv.total||0)}</div><div style="margin-top:6px"><button class="btn" onclick='viewInvoice("${inv.invoice_id}")'>View/Print</button></div>`;
    wr.appendChild(div);
  });
}

window.viewInvoice = function(id){
  const inv = invoices.find(i => i.invoice_id === id || i.invoice_id == id);
  if(!inv) return alert('inv not found');
  let items = [];
  try { items = typeof inv.items === 'string' ? JSON.parse(inv.items) : inv.items || []; } catch(e){ items = []; }
  let html = `<div style="font-weight:700;font-size:18px">${currentUser?currentUser.shop_name: 'Mhyasi Store'}</div><div>${currentUser?currentUser.shop_address:''}</div><hr><h3>Invoice ${inv.invoice_id}</h3><div>${new Date((inv.created_at||Date.now())*1000).toLocaleString()}</div><table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>`;
  items.forEach(it => html += `<tr><td>${it.name}</td><td>${it.qty}</td><td>${toCurrency(it.price)}</td><td>${toCurrency(it.qty*it.price)}</td></tr>`);
  html += `</tbody></table><div style="text-align:right;font-weight:800;margin-top:8px">Total: ${toCurrency(inv.total)}</div>`;
  const wnd = window.open('', '_blank'); wnd.document.write('<html><head><title>Invoice</title></head><body>'+html+'</body></html>'); wnd.document.close(); wnd.print();
};

/* ---------- COMPLETE SALE (server reduces stock + we sync) ---------- */
$('#completeSaleBtn').onclick = async ()=>{
  if(cart.length === 0) return alert('Cart empty');
  if(!currentUser) return openLogin();
  // check stock availability again
  for(const c of cart){
    const p = products.find(x=>String(x.id)===String(c.id));
    if(!p) return alert('Product not found: ' + c.name);
    if(c.qty > p.qty) return alert(`Insufficient stock for ${p.name}`);
  }

  const invoice_id = 'INV-' + Math.random().toString(36).slice(2,9).toUpperCase();
  const customer = $('#customerName').value.trim();
  const items = cart.map(c => ({ id: c.id, name: c.name, qty: c.qty, price: c.price }));
  const total = items.reduce((s,i)=>s + i.qty*i.price,0);

  // POST invoice (backend will also reduce qty if implemented)
  const res = await apiFetch('/api/invoices', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ invoice_id, customer, items, total })});
  if(res.status === 403) { alert(res.error || 'Account locked'); return; }
  if(!res.ok) return alert(res.error || 'Invoice save failed');

  // If backend didn't update qty properly, we still update each product via PUT to ensure qty changes persist.
  for(const it of items){
    const prod = products.find(p => String(p.id) === String(it.id));
    if(!prod) continue;
    const newQty = Math.max(0, Number(prod.qty) - Number(it.qty));
    await apiFetch(`/api/products/${prod.id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: prod.name, price: prod.price, qty: newQty })});
    prod.qty = newQty;
  }

  alert('Sale completed âœ…');
  cart = [];
  renderCart();
  renderProductsTable();
  await loadInvoices();
  await updateSummary();
};

/* ---------- PRINT CURRENT CART ---------- */
$('#printBtn').onclick = ()=>{
  if(cart.length===0) return alert('Cart empty');
  let html = `<div style="font-weight:700;font-size:18px">${currentUser?currentUser.shop_name: 'Mhyasi Store'}</div><div>${currentUser?currentUser.shop_address:''}</div><hr><h3>Invoice Preview</h3><table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>`;
  cart.forEach(c=> html += `<tr><td>${c.name}</td><td>${c.qty}</td><td>${toCurrency(c.price)}</td><td>${toCurrency(c.price*c.qty)}</td></tr>`);
  html += `</tbody></table><div style="text-align:right;font-weight:800;margin-top:8px">Total: ${toCurrency(cart.reduce((s,i)=>s + i.qty*i.price,0))}</div>`;
  const wnd = window.open('','_blank'); wnd.document.write('<html><head><title>Invoice</title></head><body>'+html+'</body></html>'); wnd.document.close(); wnd.print();
};

/* ---------- REQUEST UNLOCK & REDEEM ---------- */
$('#btnRequest').onclick = ()=> {
  if(!currentUser) return openLogin();
  showModal(`<h3>Request Unlock</h3><div><input id="reqAmount" placeholder="Amount (â‚¦)" type="number" style="width:100%"/><textarea id="reqDetails" placeholder="Details (optional)" style="width:100%;margin-top:6px"></textarea></div><div style="text-align:right;margin-top:8px"><button id="doReq" class="btn">Send</button></div>`);
  setTimeout(()=>{ $('#doReq').onclick = async ()=>{
    const amt = Number($('#reqAmount').value) || 0; const details = $('#reqDetails').value || '';
    if(amt <= 0) return alert('enter amount');
    const r = await apiFetch('/api/request', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount: amt, details })});
    if(!r.ok) return alert(r.error||'failed');
    alert('Request sent to admin');
    openWhatsAppToAdmin(`Unlock request from ${currentUser.username} â€” â‚¦${amt}. Details: ${details}`);
    closeModal();
  }; },50);
};

$('#btnEnterCode').onclick = ()=> {
  if(!currentUser) return openLogin();
  showModal(`<h3>Enter Unlock Code</h3><div><input id="codeInput" placeholder="CODE" style="width:100%"/></div><div style="text-align:right;margin-top:8px"><button id="doRedeem" class="btn">Redeem</button></div>`);
  setTimeout(()=>{ $('#doRedeem').onclick = async ()=>{
    const code = $('#codeInput').value.trim(); if(!code) return alert('enter code');
    const r = await apiFetch('/api/redeem', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code })});
    if(!r.ok) return alert(r.error||r.msg||'redeem failed');
    alert('Redeemed â€” account unlocked'); closeModal();
  }; },50);
};

/* ---------- ADMIN PANEL ---------- */
$('#btnAdmin').onclick = async ()=> {
  if(!currentUser) return openLogin();
  if(currentUser.role !== 'admin') return alert('Admin only');
  const r1 = await apiFetch('/api/requests');
  const reqs = r1.ok ? r1.requests : [];
  const r2 = await apiFetch('/api/codes');
  const codes = r2.ok ? r2.codes : [];
  let html = `<h3>Admin Panel</h3><div style="display:flex;gap:12px"><div style="flex:1"><h4>Requests</h4>`;
  reqs.forEach(r=>{
    html += `<div style="border:1px solid #eee;padding:8px;margin-bottom:8px"><div><b>${r.username}</b> â€” â‚¦${r.amount}</div><div class="small">${r.details||''}</div><div style="text-align:right;margin-top:8px"><select id="dur_${r.id}"><option value="30">30 days</option><option value="90">3 months</option><option value="365">1 year</option></select> <button onclick="approveReq(${r.id})" class="btn">Approve</button> <button onclick="declineReq(${r.id})" class="btn btn-alt">Decline</button></div></div>`;
  });
  html += `</div><div style="flex:1"><h4>Codes</h4>`;
  codes.forEach(c=>{
    html += `<div style="border:1px solid #eee;padding:8px;margin-bottom:8px"><div><b>${c.code}</b> â€” for ${c.for_username || c.for_user}</div><div class="small">Until: ${c.until ? new Date(c.until).toLocaleString() : '-'}</div></div>`;
  });
  html += `</div></div>`;
  showModal(html);
  window.approveReq = async function(reqId){
    const durEl = document.getElementById('dur_'+reqId);
    const duration = Number(durEl.value || 30);
    const r = await apiFetch('/api/approve', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ requestId: reqId, duration })});
    if(!r.ok) return alert(r.error||'fail');
    alert('Approved. Code: ' + r.code);
    openWhatsAppToAdmin(`Approved request ${reqId}. Code: ${r.code}`);
    closeModal(); await loadInvoices();
  };
  window.declineReq = async function(reqId){
    if(!confirm('Decline?')) return;
    const r = await apiFetch('/api/decline', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ requestId: reqId })});
    if(!r.ok) return alert(r.error||'fail');
    alert('Declined'); closeModal();
  };
};

/* ---------- WHATSAPP ---------- */
function openWhatsAppToAdmin(message){
  const phone = (ADMIN_PHONE||'').replace(/\D/g,'');
  if(!phone) return alert('Admin phone not configured');
  const msg = encodeURIComponent(message || 'Hello admin');
  const url = `https://wa.me/${phone}?text=${msg}`;
  window.open(url,'_blank');
}
$('#btnMsgAdmin').onclick = ()=> {
  if(!currentUser) return openLogin();
  openWhatsAppToAdmin(`Hello admin, this is ${currentUser.username}. Please assist.`);
};
$('#adminPhoneText').textContent = ADMIN_PHONE;

/* ---------- SUMMARY (stock & sold totals) ---------- */
async function updateSummary(){
  if(!token){ $('#totalSoldText').textContent = toCurrency(0); $('#stockValueText').textContent = toCurrency(0); return; }
  // stock value
  try {
    const pr = await apiFetch('/api/products');
    let stock = 0;
    if(pr.ok && pr.products) pr.products.forEach(p => stock += Number(p.price||0) * Number(p.qty||0));
    $('#stockValueText').textContent = toCurrency(stock);
  } catch(e){}
  // total sold
  try {
    const ir = await apiFetch('/api/invoices');
    let sold = 0;
    if(ir.ok && ir.invoices) ir.invoices.forEach(inv => sold += Number(inv.total||0));
    $('#totalSoldText').textContent = toCurrency(sold);
  } catch(e){}
}

/* ---------- PWA INSTALL PROMPT ---------- */
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('#btnInstall').style.display = 'inline-block';
});
$('#btnInstall').onclick = async ()=>{
  if(!deferredPrompt) return alert('Install not available');
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  if(choice.outcome === 'accepted') {
    $('#btnInstall').style.display = 'none';
  }
  deferredPrompt = null;
};

/* ---------- REFRESH HANDLER ---------- */
$('#refreshBtn').onclick = async ()=> {
  await loadProducts();
  await loadInvoices();
  updateSummary();
  alert('Refreshed');
};

/* ---------- INIT ---------- */
async function init(){
  renderAuth();
  renderProfile();
  await loadProducts();
  await loadInvoices();
  updateSummary();
  setInterval(updateSummary, 30000);
}
init();

/* ---------- SERVICE-WORKER (register if present) ---------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').catch(()=>{ /* ignore */ });
}
</script>
</body>
</html>
